(function(c,b){c.soco=c.soco||{};
c.soco.commons=c.soco.commons||{};
c.soco.TEMPLATE_PARAMNAME=":templatename";
c.soco.filterHTMLFragment=c.soco.filterHTMLFragment||function(d,f){try{f.call(null,b(d))
}catch(g){throw g
}};
var a={};
a.CLEAR="lcl.cq.soco.events.clear";
c.soco.commons.handleOnBlur=function(d,e){if((b(d).val()==="")||(b(d).val()==="<br/>")){b(d).val(e)
}};
c.soco.commons.handleOnFocus=function(d,e){if(b(d).val()===e){b(d).val("")
}};
c.soco.commons.getMessage=function(d){var f=b(d).first().val();
if(typeof CKEDITOR!=="undefined"){var e=CKEDITOR.instances[b(d).attr("id")];
if(e){f=e.getData()
}}return f
};
c.soco.commons.validateFieldNotEmptyOrDefaultMessage=function(f,e){c.soco.commons.syncRTE(f);
var d=b(f).val();
if(!e){e=""
}var g="tempRTEValidate_"+Math.floor(Math.random()*1001);
b(f).after("<div id='"+g+"' height='0px' style='visibility:hidden;' width='0px'></div>");
d=c.soco.commons.stripNonText(d);
e=c.soco.commons.stripNonText(e);
b("#"+g).append(d);
b("#"+g+" div:empty").filter(function(){return b(this)
}).remove();
b("#"+g+" p:empty").filter(function(){return b(this)
}).remove();
d=b("#"+g).html();
b("#"+g).remove();
if(b.trim(d).length===0||b.trim(d)===e){alert(c.I18n.getMessage("Comment field cannot be empty or default message."));
return false
}else{return true
}};
c.soco.commons.stripNonText=function(d){d=d.replace(/\s|&nbsp;/g,"");
d=d.replace(/\r?\n|\r/g,"");
d=d.replace(/(<|&lt;)br\s*\/*(>|&gt;)/g,"");
return d
};
c.soco.commons.syncRTE=function(d){if(typeof CKEDITOR!=="undefined"){var e=CKEDITOR.instances[b(d).attr("name")];
if(!e){e=CKEDITOR.instances[b(d).attr("id")]
}if(e&&e.checkDirty()){e.updateElement();
e.resetDirty()
}}};
c.soco.commons.clientSideComposer=function(i,k,j,e,h,g,f){var l=g||i.attr("action"),d=f||i.attr("method")||"POST";
i.find(":submit").click(function(s){var o=$.map(i.find(":input[type='file']"),function(v){var u=$(v);
if(u.val()===""||u.val()===undefined){return null
}return true
}).length>0;
if(o){return
}s.preventDefault();
var r=b(s.target).closest("form")[0],t;
if(b.isFunction(r.onsubmit)){if(!r.onsubmit.call(r,s)){return
}}var q=i.find("textarea");
c.soco.commons.syncRTE(q);
t=b(r).serialize();
if(k){t+="&"+encodeURIComponent(c.soco.TEMPLATE_PARAMNAME)+"="+encodeURIComponent(k)
}for(var p in h){t+="&"+encodeURIComponent(p)+"="+encodeURIComponent(h[p])
}b(r).find(":input:visible").each(function(){b(this).attr("disabled","disabled")
});
var n=function(v,u,w){if((w.status===201)||(w.status===200)){b(r).find(":input:visible").each(function(){switch(this.type){case"password":case"select-multiple":case"select-one":case"text":case"textarea":b(this).val("");
break;
case"checkbox":case"radio":this.checked=false
}b(this).removeAttr("disabled")
});
b(r).find(":input:hidden").each(function(){b(this).trigger(a.CLEAR)
});
j.call(null,v,u,w)
}else{b(r).find(":input:visible").each(function(){b(this).removeAttr("disabled")
});
e.call(null,w,u)
}};
var m=function(v,u){b(r).find(":input:visible").each(function(){b(this).removeAttr("disabled")
});
e.call(null,v,u)
};
b.ajax(l,{data:t,success:n,fail:m,type:d})
})
};
c.soco.commons.fillInputFromClientContext=function(d,e){if(window.CQ_Analytics&&CQ_Analytics.CCM){b(function(){var f=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME);
if(f){var g=f.getProperty(e,true)||"";
d.val(g)
}CQ_Analytics.CCM.addListener("storesloaded",function(){var h=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME);
if(h&&h.addListener){var i=h.getProperty(e,true)||"";
d.val(i);
h.addListener("update",function(){var j=h.getProperty(e,true)||"";
d.val(j)
})
}})
})
}};
c.soco.commons.activateRTE=function(f,d){var e=f.find("textarea");
c.soco.commons.convertTextAreaToRTE(e,d,true)
};
c.soco.commons.convertTextAreaToRTE=function(d,g,j){var e=d.width(),q=d.height(),p=[{name:"basicstyles",items:["Bold","Italic","Underline"]}],n={},m=d[0],o,k;
var h=g||["onfocus","onblur"];
if(m!==null&&typeof m!=="undefined"){for(k=0;
k<h.length;
k++){o=h[k];
if(null!==m[o]){n[o.substring(2)]=m[o]
}}}o=null;
b(d).height(d.height()+60);
var f={width:e,height:q,toolbar:p};
if(!j){f.width=d.width()===0?"100%":e;
f.height=d.height()===0?"100%":q;
f.toolbarLocation="bottom";
f.resize_enabled=false;
f.removePlugins="elementspath"
}else{f.width=e+4;
f.height=q+60
}var l=CKEDITOR.replace(b(d).attr("name"),f);
l.on("key",function(i){c.soco.commons.syncRTE(d)
});
d.on(a.CLEAR,function(i){b(m).val("");
l.setData("",function(){b(l).blur();
l.resetDirty()
})
});
return l
};
c.soco.commons.openModeration=function(){var d="";
if(c.WCM!==undefined&&c.WCM.getPagePath!==undefined){d=c.WCM.getPagePath()
}else{if(Granite.author!==undefined&&Granite.author.page!==undefined&&Granite.author.page.path!==undefined){d=Granite.author.page.path
}}c.shared.Util.open(c.shared.HTTP.externalize("/communities/moderation.html"))
};
c.soco.commons.showUGCFormAsDialog=function(h,f){var g=b(f);
var d=g.attr("id");
var e="modalIframeParent"+Math.random().toString(36).substring(2,4);
if(!d){g.attr("id",e);
d=e
}g.dialog({modal:true,height:500,width:750,buttons:{Submit:function(){var i=b("iframe.modalIframeClass",g).contents().find("form");
i.submit();
b(this).dialog("close")
},Cancel:function(){b(this).dialog("close")
}}});
g.html("<iframe class='modalIframeClass' width='100%' height='100%' marginWidth='0' marginHeight='0' frameBorder='0' />").dialog("open");
b("#"+d+" .modalIframeClass").attr("src",h);
return false
}
})(CQ,$CQ);
var CQ_collab_comments_loadedForms={};
var CQ_collab_comments_defaultMessage="";
var CQ_collab_comments_requireLogin=false;
var CQ_collab_comments_enterComment="Please enter a comment";
function CQ_collab_comments_toggleForm(c,h,a){var d=document.getElementById(h);
var b=document.getElementById(c);
try{a=CQ.shared.HTTP.noCaching(a);
CQ.shared.HTTP.get(a,function(p,k,j){var e=j.responseText;
$CQ(d).html(e);
var n=$CQ(d).children("form").attr("id");
if(n){var m=n.split("-");
m.length=m.length-1;
var l=m.join("-");
if(CQ_Analytics&&CQ_Analytics.CCM){var i=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME);
if(i){CQ_collab_comments_formStateChanged(l,i)
}}}})
}catch(g){alert("Error loading form: "+a)
}var f=d.style.display!="block";
d.style.display=f?"block":"none";
b.innerHTML=f?"Cancel":"Reply"
}function CQ_collab_comments_handleOnFocus(a,b){if(a.value==CQ_collab_comments_getDefaultMessage(b)){a.value=""
}a.style.color="#333"
}function CQ_collab_comments_handleOnBlur(a,b){if(a.value===""){a.value=CQ_collab_comments_getDefaultMessage(b);
a.style.color="#888"
}else{a.style.color="#333"
}}function CQ_collab_comments_validateFields(b){var a=document.getElementById(b+"-text");
if(a.value===""||a.value===CQ_collab_comments_getDefaultMessage(b)){CQ_collab_comments_showError(CQ_collab_comments_enterComment,b);
return false
}return true
}function CQ_collab_comments_validateSubmit(d){if(!CQ_collab_comments_validateFields(d)){return false
}try{var a=document.getElementById(d+"-id");
if(!a){var b=document.getElementById(d+"-form");
a=document.createElement("input");
a.id=d+"-id";
a.type="hidden";
a.name="id";
a.value="nobot";
b.appendChild(a)
}}catch(c){return false
}return true
}function CQ_collab_comments_showError(b,c){var a=document.getElementById(c+"-error");
if(!a){alert(b)
}else{a.innerHTML=b
}}function CQ_collab_comments_getDefaultMessage(a){if(a&&document.getElementById(a+"-rating")){return CQ_collab_ratings_defaultMessage
}return CQ_collab_comments_defaultMessage
}function CQ_collab_comments_openCollabAdmin(){CQ.shared.Util.open(CQ.shared.HTTP.externalize("/socoadmin.html#/content/usergenerated"+CQ.WCM.getPagePath()))
}function CQ_collab_comments_activate(a,b){if(!a){a="Activate"
}CQ.HTTP.post("/bin/replicate.json",function(d,e,c){if(a==="Delete"){CQ.Notification.notify(null,e?CQ.I18n.getMessage("Comment deleted"):CQ.I18n.getMessage("Unable to delete comment"))
}else{CQ.Notification.notify(null,e?CQ.I18n.getMessage("Comment activated"):CQ.I18n.getMessage("Unable to activate comment"))
}if(b){b.call(this,d,e,c)
}},{_charset_:"utf-8",path:this.path,cmd:a})
}function CQ_collab_comments_refresh(){if(this.refreshCommentSystem){this.refreshCommentSystem()
}else{CQ.wcm.EditBase.refreshPage()
}}function CQ_collab_comments_afterEdit(a){CQ_collab_comments_activate.call(a,"Activate",CQ_collab_comments_refresh)
}function CQ_collab_comments_afterDelete(a){CQ_collab_comments_activate.call(a,"Delete",CQ_collab_comments_refresh)
}function CQ_collab_comments_initFormState(a){if(CQ_Analytics&&CQ_Analytics.CCM){$CQ(function(){CQ_Analytics.ClientContextUtils.onStoreRegistered(CQ_Analytics.ProfileDataMgr.STORENAME,function(b){CQ_collab_comments_formStateChanged(a,b);
b.addListener("update",function(){CQ_collab_comments_formStateChanged(a,b)
})
})
})
}}function CQ_collab_comments_formStateChanged(a,g){var c=g.getData();
if(c){var h=a+"-form";
var j=a+"-text";
var b=a+"-userIdentifier";
var e=a+"-email";
var i=a+"-url";
var f=c.authorizableId;
var d=c.formattedName;
if(!d){d=f
}if(f&&f=="anonymous"){if(CQ_collab_comments_requireLogin){$CQ("#"+h).hide();
$CQ("[id$=-reply-button]").hide();
$CQ("[id$=-reply-arrow]").hide()
}else{$CQ("#"+h).show();
$CQ("[id$=-reply-button]").show();
$CQ("[id$=-reply-arrow]").show();
$CQ("#"+b).attr("value","");
$CQ("#"+b+"-comment-block").show();
$CQ("#"+e).attr("value","");
$CQ("#"+e+"-comment-block").show();
$CQ("#"+i).attr("value","");
$CQ("#"+i+"-comment-block").show();
$CQ("[id$=-signed-in-text]").hide();
$CQ("[id$=-signed-in-user]").text("")
}}else{$CQ("[id$=-reply-button]").show();
$CQ("[id$=-reply-arrow]").show();
$CQ("#"+b+"-comment-block").hide();
$CQ("#"+b).attr("value",f);
$CQ("#"+e+"-comment-block").hide();
$CQ("#"+i+"-comment-block").hide();
$CQ("[id$=-signed-in-user]").text(d);
$CQ("[id$=-signed-in-text]").show()
}}}(function(l,j,i,h){window.CQ_Analytics=window.CQ_Analytics||{};
var b=CQ_Analytics;
var f=h.Model.extend({modelName:"CommentSystemModel",relationships:{items:{collection:"CommentList",model:"CommentModel"}},createOperation:"social:createComment",MOVE_OPERATION:"social:moveComment",getCustomProperties:function(m,n){return j.extend(m,n)
},events:{MOVED:"comment:moved",MOVE_ERROR:"comment:moveError",ADD:"comment:added",ADD_ERROR:"comment:adderror"},_fixCachedProperties:function(){if(h.hasOwnProperty("Session")&&(h.Session!==null)){var m=h.Session.attributes.mayPost;
this.attributes.mayPost=m;
this.fixCachedProperties();
this.cacheFixed=true;
this.trigger("model:cacheFixed",this)
}},fixCachedProperties:function(){},constructor:function(m,n){h.Model.prototype.constructor.apply(this,[m,n]);
if(h.Session.isReady()){this._fixCachedProperties()
}else{h.Session.on("model:loaded",j.bind(this._fixCachedProperties,this))
}},shouldCommentBeAddedToList:function(m){return true
},addCommentSuccess:function(n){if(CQ){var t=CQ.shared.HTTP.getPath()+"."+CQ.shared.HTTP.getExtension()
}else{var t=location.protocol+"//"+location.host+location.pathname
}CQ.shared.Util.load(t);
var p=n.response;
var s=h.Models[this.constructor.prototype.relationships.items.model];
var r=new s(p);
if(this.shouldCommentBeAddedToList(r)){r.set("_isNew",true);
r._isReady=true;
var q=this.get("items");
var u=false;
if(!q){var o=h.Collections[this.constructor.prototype.relationships.items.collection]||i.Collection;
q=new o();
q.model=s;
q.parent=this;
u=true
}q.unshift(r);
var m=this.get("totalSize");
if(u){this.set("items",q)
}this.set("totalSize",m+1);
r.constructor.prototype._cachedModels[p.id]=r;
this.trigger(this.events.ADD,{model:this})
}},addComment:function(q,o,t){l(".scf-attachment-error").remove();
var s=j.bind(this.addCommentSuccess,this);
var p=j.bind(function(x,w,u){if(500==x.status){var v=l(".scf-composer-block")[0];
if(null===v){v=l(document.body)
}l('<div class="scf-attachment-error"><h3 class="scf-js-error-message">Server error. Please try again.</h3><div>').appendTo(v);
return false
}this.trigger(this.events.ADD_ERROR,this.parseServerError(x,w,u))
},this);
var n;
var m=(typeof q.files!=="undefined");
var r=(typeof q.tags!=="undefined");
if(m){if(window.FormData){n=new FormData()
}if(n){l.each(q.files,function(u,v){n.append("file",v)
});
n.append("id","nobot");
n.append(":operation",this.createOperation);
delete q.files;
if(r){l.each(q.tags,function(u,v){n.append("tags",v)
})
}delete q.tags;
l.each(q,function(u,v){n.append(u,v)
})
}}else{n={id:"nobot",":operation":this.createOperation};
j.extend(n,q);
n=this.getCustomProperties(n,q)
}l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",type:"POST",processData:!m,contentType:(m)?false:"application/x-www-form-urlencoded; charset=UTF-8",xhrFields:{withCredentials:true},data:this.addEncoding(n),success:s,error:p})
},addIncludeHint:function(m){j.extend(m,{"scf:included":this.get("pageInfo").includedPath,"scf:resourceType":this.get("resourceType")})
},move:function(n){var m=j.bind(function(r,q,p){this.trigger(this.events.MOVE_ERROR,{error:p})
},this);
var o=j.bind(this.addCommentSuccess,this);
l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:{":operation":this.MOVE_OPERATION,resourcePath:n.resourcePath,parentPath:n.parentPath},success:o,error:m})
},translateAll:function(s){h.CommentSystem.thisRef=this;
if(this.get("showingTranslationAll")===undefined){this.set("showingTranslationAll",false)
}var n=this.get("items");
var r=[];
r.push(this);
var p;
for(p in n.models){r.push(n.models[p])
}var o=0;
var m=[];
var q=function(){o--;
if(o<=0){h.CommentSystem.thisRef.set("translateAllInProgress",false);
if(h.CommentSystem.thisRef.get("showingTranslationAll")===true){h.CommentSystem.thisRef.set("showingTranslationAll",false)
}else{h.CommentSystem.thisRef.set("showingTranslationAll",true)
}if(h.CommentSystem.thisRef.view){h.CommentSystem.thisRef.view.render()
}}};
if(this.get("showingTranslationAll")===false){for(p in r){if(r[p].get("canTranslate")&&!r[p].get("showingTranslation")){o++;
m.push(r[p])
}}if(o>0){this.set("translateAllInProgress",true);
if(this.view){this.view.render()
}}if(o===0){this.set("showingTranslationAll",true);
if(this.view){this.view.render()
}return
}}else{for(p in r){if(r[p].get("canTranslate")&&r[p].get("showingTranslation")){o++;
m.push(r[p])
}}if(o===0){this.set("showingTranslationAll",false);
if(this.view){this.view.render()
}return
}}for(p in m){m[p].translate(q)
}}});
var e=h.View.extend({viewName:"CommentSystem",className:"comment-system",CREATE_EVENT:"SCFCreate",COMMUNITY_FUNCTION:"Comment System",getOtherProperties:function(){return{}
},PAGE_EVENT:"pageComments",PAGE_URL_PREFIX:"comments",init:function(){this.listenTo(this.model,this.model.events.ADD,this.update);
this.listenTo(this.model,this.model.events.ADD_ERROR,this.showErrorOnAdd);
this.listenTo(this.model.get("items"),"comment:deleted",function(m){this.model.set({totalSize:this.model.get("totalSize")-1});
if(h.Util.mayCall(this.model.get("items"),"remove")){this.model.get("items").remove(m.model)
}this.render()
});
this.listenTo(this.model,this.model.events.ADD,this.recordCreate);
this.listenTo(h.Router,"route:"+this.PAGE_EVENT,this.paginate);
h.Router.route(/^(.*?)\.([0-9]*)\.(-?[0-9]*)\.htm.*?$/,this.PAGE_EVENT);
this.model.view=this
},recordCreate:function(){if(!j.isUndefined(window._satellite)){window._satellite.track("communities-scf-create")
}else{if(b.Sitecatalyst){b.record({event:this.CREATE_EVENT,values:{functionType:h.Context.communityFunction?h.Context.communityFunction:this.COMMUNITY_FUNCTION,path:h.Context.path?h.Context.path:this.model.get("id"),type:h.Context.type?h.Context.type:this.model.get("resourceType"),ugcTitle:h.Context.ugcTitle,siteTitle:h.Context.siteTitle?h.Context.siteTitle:$(".scf-js-site-title").text(),sitePath:h.Context.sitePath?h.Context.sitePath:this.sitePath,groupTitle:h.Context.groupTitle,groupPath:h.Context.groupPath,user:h.Context.user?h.Context.user:h.Session.get("authorizableId")},collect:false,componentPath:h.constants.ANALYTICS_BASE_RESOURCE_TYPE})
}}},paginate:function(){var q=h.config.urlRoot+this.model.get("id")+h.constants.SOCIAL_SELECTOR+".";
var m=arguments[0];
var o=arguments[1];
var p=arguments[2];
var r=(arguments.length<=3)?null:arguments[3];
var n=null;
if(arguments.length<=3){n=q+o+"."+p+h.constants.JSON_EXT
}else{n=q+"index."+o+"."+p+"."+r+h.constants.JSON_EXT
}this.model.url=n+window.location.search;
this.model.reload()
},update:function(){this.files=void 0;
this.render()
},requiresSession:true,showErrorOnAdd:function(m){this.$el.find(".scf-js-composer-block input[type='text'], textarea").addClass("scf-error");
this.addErrorMessage(this.$el.find(".scf-js-composer-block input[type='text'], textarea").first(),m);
this.log.error(m)
},hideError:function(){},expandComposer:function(){this.$el.find(".scf-js-composer-block:first").removeClass("scf-is-collapsed");
var n=this.$el.find(".scf-js-composer-block");
var p=this.getField("message");
var o=CQ.I18n.get("Write a comment");
var m=p.substring(0,o.length);
if(o==m){this.setField("message","")
}if(n.is(":visible")){if(""===p){this.setField("message","")
}}else{this.files=void 0;
this.$el.find(".scf-attachment-list").first().empty()
}this.focus("message")
},cancelComposer:function(){this.$el.find(".scf-js-composer-block:first").addClass("scf-is-collapsed");
this.files=undefined;
l(".scf-js-composer-att").empty();
this.setField("message","");
this.clearErrorMessages()
},toggleComposer:function(m){l(".scf-attachment-error").remove()
},addCommentDraft:function(n){var m=this.extractCommentData(n);
m.isDraft=true;
return this.addToCommentModel(m,n)
},addToCommentModel:function(m,n){this.model.addComment(m);
n.preventDefault();
return false
},addComment:function(n){var m=this.extractCommentData(n);
return this.addToCommentModel(m,n)
},extractCommentData:function(o){var p=this.getField("message");
var m=this.getField("tags");
var n=j.extend(this.getOtherProperties(),{message:p,tags:m});
if(!h.Session.get("loggedIn")){n.userIdentifier=this.getField("anon-name");
n.email=this.getField("anon-email");
n.url=this.getField("anon-web")
}if(typeof this.files!=="undefined"){n.files=this.files
}this.clearErrorMessages();
return n
},navigate:function(u){var w=window.location.protocol+"//"+window.location.host;
var z=l(u.target).data("page-suffix");
var A=this.model.get("pageInfo");
var p=h.config.urlRoot;
var s=A.basePageURL;
var n=window.location.search;
var t=window.location.pathname;
var m=t.substr(t.lastIndexOf(".html")+5);
var y=/(.*)\.(\w*)?\.(\d*)?\.(\d*)?\.html(\/.*)?/;
var r=/(.*)\.(\w*)?\.html(\/.*)?/;
var v=/(.*)\.html(\/.*)?/;
if(j.isUndefined(s)||s===null){var B=t;
var o=y.exec(B);
if(o){B=o[1]+"."+o[2]
}else{o=r.exec(B);
if(o){B=o[1]+"."+o[2]
}else{o=v.exec(B);
B=o[1]
}}s=B
}if(w.indexOf(h.config.urlRoot)!=-1){var x=s+"."+z+".html"+m;
x=j.isEmpty(n)?x:x+n;
h.Router.navigate(x,{trigger:true})
}else{z=$(u.currentTarget).data("pageSuffix");
var q=z.split(".");
if(A.selectedIndex!==null){this.paginate(s,q[0],q[1],A.selectedIndex)
}else{this.paginate(s,q[0],q[1])
}}},renderAttachmentList:function(p){p.preventDefault();
this.files=p.target.files;
var m=l(".scf-js-composer-att");
m.empty();
for(var n=0;
n<this.files.length;
n++){var o=this.files[n];
var q=l('<li class="scf-is-attached">'+j.escape(o.name)+" - "+o.size+" bytes</li>");
m.append(q)
}},openAttachmentDialog:function(m){if(h.Util.mayCall(m,"preventDefault")){m.preventDefault()
}this.$el.find("input[type='file']").first().click()
},translateAll:function(){this.model.translateAll()
}});
var d=h.Model.extend({modelName:"CommentModel",DELETE_OPERATION:"social:deleteComment",UPDATE_OPERATION:"social:updateComment",CREATE_OPERATION:"social:createComment",EDIT_TRANSLATION_OPERATION:"social:editTranslation",events:{ADDED:"comment:added",UPDATED:"comment:updated",DELETED:"comment:deleted",ADD_ERROR:"comment:addError",UPDATE_ERROR:"comment:updateError",DELETE_ERROR:"comment:deleteError",TRANSLATED:"comment:translated",TRANSLATE_ERROR:"comment:translateError"},initialize:function(){if(this.isTranslationPresent()){this.set("showingTranslation",true);
h.Comment.isSmartRenderingOn=true
}this.on("change",function(){if(h.Comment.isSmartRenderingOn===true){if(this.get("showingTranslation")===undefined&&this.isTranslationPresent()){this.set("showingTranslation",true)
}}})
},_fixCachedProperties:function(){if(!this._isReady){this.on("model:loaded",j.bind(this._fixCachedProperties,this));
return
}this.off("model:loaded",j.bind(this._fixCachedProperties,this));
if(h.hasOwnProperty("Session")&&(h.Session!==null)){var n=this.attributes.canEdit;
var m=this.attributes.canDelete;
var w=this.attributes.isFlaggedByUser;
var u=this.attributes.approved;
var t=this.attributes.moderatorActions||{};
var v=h.Session.attributes.loggedIn;
var o=j.isUndefined(h.Session.attributes.id)?"":h.Session.attributes.id.substr(h.Session.attributes.id.lastIndexOf("/")+1);
var s=(this.attributes.author||false)&&h.Session.attributes.loggedIn&&((this.attributes.author.id===h.Session.attributes.id)||((this.attributes.properties||false)&&this.attributes.properties.composedBy===o));
var p=(this.attributes.moderatorStatus||false)&&this.attributes.moderatorStatus.hasOwnProperty("isFlagged")?this.attributes.moderatorStatus.isFlagged:false;
var q=(this.attributes.moderatorStatus||false)&&this.attributes.moderatorStatus.hasOwnProperty("isSpam")?this.attributes.moderatorStatus.isSpam:false;
var r=h.Session.checkIfModeratorFor(this.attributes.sourceComponentId);
t.canAllow=r&&!this.attributes.isClosed&&(q||p||!this.attributes.approved);
t.canDeny=(this.attributes.configuration||false)&&r&&!q&&this.attributes.configuration.isDenyAllowed;
t.canClose=(this.attributes.configuration||false)&&r&&this.attributes.topLevel&&this.attributes.configuration.isCloseAllowed;
t.canFlag=!this.attributes.isClosed&&!w&&v&&u&&!s&&!q&&!p&&this.attributes.configuration.isFlaggingAllowed;
this.attributes.canEdit=r||((this.attributes.configuration||false)&&s&&this.attributes.configuration.isEditAllowed&&!this.attributes.isClosed);
this.attributes.canDelete=r||((this.attributes.configuration||false)&&s&&this.attributes.configuration.isDeleteAllowed&&!this.attributes.isClosed);
this.attributes.canReply=h.Session.attributes.mayReply&&(this.attributes.configuration.isReplyAllowed&&!this.attributes.isClosed);
this.attributes.moderatorActions=t;
this.fixCachedProperties(r);
this.cacheFixed=true;
this.trigger("model:cacheFixed",this)
}},fixCachedProperties:function(m){},constructor:function(m,n){h.Model.prototype.constructor.apply(this,[m,n]);
if(h.Session.isReady()){this._fixCachedProperties()
}else{h.Session.on("model:loaded",j.bind(this._fixCachedProperties,this))
}},remove:function(){var m=j.bind(function(q,p,o){this.trigger(this.events.DELETE_ERROR,{error:o})
},this);
var n=j.bind(function(o){this.trigger(this.events.DELETED,{model:this});
this.trigger("destroy",this)
},this);
l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:{":operation":this.DELETE_OPERATION},success:n,error:m})
},saveEditTranslation:function(){var n=j.bind(function(r,q,p){this.trigger(this.events.UPDATE_ERROR,this.parseServerError(r,q,p))
},this);
var o=j.bind(function(p){this.reset(p.response,{silent:true});
this.set("showingTranslation",true,{silent:true});
this.set("editTranslationInProgress",false,{silent:true});
if(this.get("translationDisplay")==="side"){this.set("displaySideBySide",true,{silent:true})
}if(this.get("isVisible")){this.trigger(this.events.UPDATED,{model:this})
}else{this.trigger(this.events.DELETED,{model:this});
this.trigger("destroy",this)
}},this);
var m={translatedText:this.get("message"),id:"nobot",":operation":this.EDIT_TRANSLATION_OPERATION};
l.ajax(h.config.urlRoot+this.get("id")+h.constants.TRANSLATE_URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(m),success:o,error:n})
},saveEdits:function(){var p=j.bind(function(u,t,s){this.trigger(this.events.UPDATE_ERROR,this.parseServerError(u,t,s))
},this);
var r=j.bind(function(s){this.reset(s.response,{silent:true});
if(this.get("isVisible")){this.trigger(this.events.UPDATED,{model:this})
}else{this.trigger(this.events.DELETED,{model:this});
this.trigger("destroy",this)
}},this);
var n=null;
var q=this.get("files");
var m=(typeof q!=="undefined");
var o=this.get("tags");
if(m){if(window.FormData){n=new FormData()
}if(n){l.each(q,function(s,t){n.append("file",t)
});
n.append("id","nobot");
n.append(":operation",this.UPDATE_OPERATION);
n.append("message",this.get("message"));
l.each(this.getCustomProperties(),function(s,t){n.append(s,t)
});
if(o){l.each(o,function(s,t){n.append("tags",t)
})
}}}if(n===null){n={message:this.get("message"),id:"nobot",":operation":this.UPDATE_OPERATION};
if(o){n.tags=o
}n=j.extend(this.getCustomProperties(),n)
}l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",processData:!m,contentType:(m)?false:"application/x-www-form-urlencoded; charset=UTF-8",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(n),success:r,error:p})
},loadMore:function(){var m=this.get("pageInfo").nextPageURL;
if(m.indexOf(".html",this.length-5)!==-1){m=m.substr(0,m.lastIndexOf(".html"))+".json"
}var o=this;
var n=this.constructor.find(m,function(q){var p=q.get("items");
var r=q.get("pageInfo");
o.set("pageInfo",r);
var s=o.get("items");
s.add(p.models,{silent:true,merge:true});
o.trigger(o.events.UPDATED,{model:o})
},true)
},getCustomProperties:function(){return{}
},isTranslationPresent:function(){var m=this.get("translationDescription");
return(!j.isEmpty(m))
},translate:function(o){if(this.get("translationAjaxInProgress")!==true){if(this.isTranslationPresent()){var q=true;
if(this.get("showingTranslation")===true){q=false
}this.set({showingTranslation:q});
this.trigger(this.events.UPDATED,{model:this});
if(o){o()
}return
}this.set("translationAjaxInProgress",true);
var n=j.bind(function(t,s,r){this.set("translationAjaxInProgress",false);
this.trigger(this.events.TRANSLATE_ERROR,this.parseServerError(t,s,r))
},this);
var p=j.bind(function(r){this.set("translationAjaxInProgress",false);
this.reset(r,{silent:true});
this.set({showingTranslation:true});
if(this.get("translationDisplay")==="side"){this.set("displaySideBySide",true,{silent:true})
}this.trigger(this.events.UPDATED,{model:this});
if(o){o()
}},this);
var m=h.config.urlRoot+this.get("id")+h.constants.TRANSLATE_URL_EXT;
l.ajax({type:"GET",url:m,dataType:"json",success:p,error:n});
this.trigger(this.events.UPDATED,{model:this})
}},addReply:function(q,o,s){var r=j.bind(function(w){var y=w.response;
var u=this.constructor.prototype.relationships.items.model;
var v=h.Models[u];
if(j.isUndefined(v)){this.log.error("reply model not found: "+u);
return
}var A=new v(y);
A._isReady=true;
A.set("_isNew",true);
var z=this.get("items");
var B=false;
if(!z){var x=h.Collections[this.constructor.prototype.relationships.items.collection]||i.Collection;
z=new x();
z.model=this.constructor;
z.parent=this;
B=true
}z.push(A);
var t=this.get("totalSize");
if(B){this.set("items",z)
}this.set("totalSize",t+1);
A.constructor.prototype._cachedModels[y.id]=A;
this.trigger(this.events.ADDED,{model:this})
},this);
var p=j.bind(function(v,u,t){this.trigger(this.events.ADD_ERROR,this.parseServerError(v,u,t))
},this);
var n;
var m=(typeof q.files!="undefined");
if(m){if(window.FormData){n=new FormData()
}if(n){l.each(q.files,function(t,u){n.append("file",u)
});
n.append("id","nobot");
n.append(":operation",this.CREATE_OPERATION);
delete q.files;
l.each(q,function(t,u){n.append(t,u)
})
}}else{n={id:"nobot",":operation":this.CREATE_OPERATION};
j.extend(n,q)
}l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",type:"POST",processData:!m,contentType:(m)?false:"application/x-www-form-urlencoded; charset=UTF-8",xhrFields:{withCredentials:true},data:this.addEncoding(n),success:r,error:p})
},flag:function(o,p){var n=j.bind(function(t,s,r){this.log.error("error flagging comment "+r);
this.trigger("comment:flagerror",{error:r})
},this);
var q=j.bind(function(r){this.reset(r.response,{silent:true});
if(this.get("isVisible")){this.trigger("comment:flagged",{model:this});
this.trigger(this.events.UPDATED,{model:this})
}else{this.trigger(this.events.DELETED,{model:this});
this.trigger("destroy",this)
}},this);
var m={id:"nobot",":operation":"social:flag","social:flagformtext":o,"social:doFlag":p};
l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(m),success:q,error:n})
},allow:function(){var n=j.bind(function(r,q,p){this.log.error("error allowing comment "+p);
this.trigger("comment:allowerror",{error:p})
},this);
var o=j.bind(function(p){this.reset(p.response);
this.trigger("comment:allowed",{model:this});
this.trigger(this.events.UPDATED,{model:this})
},this);
var m={id:"nobot",":operation":"social:allow"};
l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(m),success:o,error:n})
},resetChildren:function(){var m=this.get("items");
j.each(m,function(n){n.destroy()
})
},close:function(n){var o=j.bind(function(t,s,r){this.log.error("error closing/opening comment "+r);
this.trigger("comment:closeopenerror",{error:r})
},this);
var q=j.bind(function(r){this.resetChildren();
this.reset(r.response);
this.trigger("comment:closedOpened",{model:this});
this.trigger(this.events.UPDATED,{model:this})
},this);
var p=n?"true":"false";
var m={id:"nobot",":operation":"social:close","social:doClose":p};
l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(m),success:q,error:o})
},deny:function(){var n=j.bind(function(r,q,p){this.log.error("error denying comment "+p);
this.trigger("comment:denyerror",{error:p})
},this);
var o=j.bind(function(p){this.reset(p.response);
this.trigger("comment:denied",{model:this});
this.trigger(this.events.UPDATED,{model:this})
},this);
var m={id:"nobot",":operation":"social:deny"};
l.ajax(h.config.urlRoot+this.get("id")+h.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(m),success:o,error:n})
},addIncludeHint:function(o){var m=this;
var n=null;
while(m!==null){if(m.hasOwnProperty("collection")){m=m.collection
}else{n=m.parent.get("resourceType");
m=null
}}j.extend(o,{"scf:included":this.get("pageInfo").includedPath,"scf:resourceType":n})
},relationships:{items:{collection:"CommentList",model:"CommentModel"},votes:{model:"VotingModel"}}});
var a=h.View.extend({viewName:"Comment",CREATE_EVENT:"SCFCreate",COMMUNITY_FUNCTION:"Comment System",init:function(){this.listenTo(this.model,this.model.events.ADDED,this.update);
this.listenTo(this.model,this.model.events.ADD_ERROR,this.showError);
this.listenTo(this.model,this.model.events.UPDATED,this.commentViewUpdate);
this.listenTo(this.model,this.model.events.DELETED,this.removeView);
this.listenTo(this.model,this.model.events.ADDED,this.recordCreate);
this.model.view=this;
if(this.model.isTranslationPresent()){if(this.model.get("translationDisplay")==="side"){this.model.set("displaySideBySide",true)
}}},loadMore:function(m){m.preventDefault();
this.model.loadMore()
},removeView:function(){return i.View.prototype.remove.apply(this,arguments)
},commentViewUpdate:function(){this.render()
},update:function(){this.files=undefined;
this.render()
},recordCreate:function(){if(!j.isUndefined(window._satellite)){window._satellite.track("communities-scf-create")
}else{if(b.Sitecatalyst){b.record({event:this.CREATE_EVENT,values:{functionType:h.Context.communityFunction?h.Context.communityFunction:this.COMMUNITY_FUNCTION,path:h.Context.path?h.Context.path:this.model.get("id"),type:h.Context.type?h.Context.type:this.model.get("resourceType"),ugcTitle:h.Context.ugcTitle,siteTitle:h.Context.siteTitle?h.Context.siteTitle:$(".scf-js-site-title").text(),sitePath:h.Context.sitePath?h.Context.sitePath:this.sitePath,groupTitle:h.Context.groupTitle,groupPath:h.Context.groupPath,user:h.Context.user?h.Context.user:h.Session.get("authorizableId")},collect:false,componentPath:h.constants.ANALYTICS_BASE_RESOURCE_TYPE})
}}},afterRender:function(){this.model.unset("_isNew");
var m=$(".generic-translation-all-button");
if(m){if(this.model.get("canTranslate")===true&&!m.show()){m.show()
}}$(".scf-comment-edit").each(function(){this.remove()
});
$(".scf-comment-replies .scf-comment-reply").each(function(){this.remove()
})
},showError:function(m){var n=this.$el.find(".scf-js-comment-reply-box:first textarea");
this.$el.find(n).addClass("scf-error");
this.addErrorMessage(n,m);
this.log.error(m)
},hideError:function(){},edittranslation:function(m){this.model.set("editTranslationInProgress",true);
m.stopPropagation();
var o=this.$el.find(".scf-js-comment-edit-box:first");
o.toggle();
this.$el.find(".scf-js-comment-msg:first").toggle();
var n=this.model.get("translationDescription");
this.setField("editMessage",n);
this.focus("editMessage")
},translate:function(){this.model.translate()
},addReply:function(n){var o=this.getField("replyMessage");
var m=j.extend(this.getOtherProperties(),{message:o});
if(!h.Session.get("loggedIn")){m.userIdentifier=this.getField("anon-name");
m.email=this.getField("anon-email");
m.url=this.getField("anon-web")
}if(typeof this.files!="undefined"){m.files=this.files
}this.clearErrorMessages();
this.model.addReply(m);
n.preventDefault();
return false
},addReplyFromData:function(n,m){if(!h.Session.get("loggedIn")){m.userIdentifier=this.getField("anon-name");
m.email=this.getField("anon-email");
m.url=this.getField("anon-web")
}if(typeof this.files!="undefined"){m.files=this.files
}this.clearErrorMessages();
this.model.addReply(m);
n.preventDefault();
return false
},reply:function(n){n.stopPropagation();
var m=this.$el.find(".scf-js-comment-reply-box:first");
m.toggle();
this.focus("replyMessage");
this.setField("replyMessage","")
},remove:function(m){m.stopPropagation();
var n=this.$el.find(".comment-delete-box:first");
this._closeModal=this.launchModal(n,"Delete")
},noDelete:function(m){m.stopPropagation();
this._closeModal();
this._closeModal=undefined
},reallyDelete:function(m){m.stopPropagation();
this.model.remove();
this._closeModal();
this._closeModal=undefined
},edit:function(m){m.stopPropagation();
this.model.set("editTranslationInProgress",false);
var o=this.$el.find(".scf-js-comment-edit-box:first");
o.toggle();
this.$el.find(".scf-js-comment-msg:first").toggle();
this.$el.find(".scf-comment-action").hide();
var n=this.model.get("message");
this.setField("editMessage",n);
this.focus("editMessage")
},save:function(n){var m=this.getData();
this.saveOperation(n,m)
},saveDraft:function(n){var m=this.getData();
m.isDraft=true;
this.saveOperation(n,m)
},publishDraft:function(n){var m=this.getData();
this.saveOperation(n,m)
},saveOperation:function(o,n){o.stopPropagation();
o.preventDefault();
var m=this.model.get("editTranslationInProgress");
this.clearErrorMessages();
this.model.set(n);
if(m){this.model.saveEditTranslation()
}else{this.model.saveEdits()
}return false
},getData:function(){var m=this.getField("editMessage");
var n=this.getField("editTags");
var o=j.extend(this.getOtherProperties(),{message:m,tags:n});
if(typeof this.files!="undefined"){o.files=this.files
}return o
},cancelComposer:function(n){n.stopPropagation();
this.clearErrorMessages();
var m=this.$el.find(".scf-js-comment-reply-box:first");
m.toggle();
this.files=undefined
},cancel:function(p){p.stopPropagation();
this.clearErrorMessages();
var q=this.$el.find(".scf-js-comment-edit-box:first");
q.hide();
var o=this.model.changedAttributes();
if(o){var n=j.keys(o);
var m=j.pick(this.model.previousAttributes(),n);
this.model.set(m)
}this.$el.find(".scf-js-comment-msg:first").show();
this.$el.find(".scf-comment-action").show()
},getOtherProperties:function(){return{}
},editFlagReason:function(n){n.preventDefault();
var m=this.$el.find(".scf-js-flagreason-box:first");
this._closeDialog=this.launchModal(m,"Flag")
},cancelFlagging:function(m){m.preventDefault();
this._closeDialog();
this._closeDialog=undefined
},addFlagReason:function(n){n.preventDefault();
var m=this.getField("flagReason");
if(m.length===0||m==="custom"){m=this.getField("customFlagReason")
}if(m.length!==0){this.model.flag(m,true)
}else{this.model.flag("",true)
}this._closeDialog();
this._closeDialog=undefined
},toggleFlag:function(n){n.preventDefault();
var m=this.$el.find(".scf-js-toggleFlag-box:first");
m.toggle()
},removeFlag:function(m){m.preventDefault();
this.model.flag(null,false)
},close:function(m){m.preventDefault();
this.model.close(true)
},open:function(m){m.preventDefault();
this.model.close(false)
},allow:function(m){m.preventDefault();
this.model.allow()
},deny:function(m){m.preventDefault();
this.model.deny()
},getLastPath:function(){var m=this.model.get("id");
var n=m.lastIndexOf("/");
n=m.slice(n+1);
return n
},renderAttachmentList:function(p){p.preventDefault();
this.files=p.target.files;
var m=l(".scf-js-composer-att");
m.empty();
for(var n=0;
n<this.files.length;
n++){var o=this.files[n];
var q=l('<li class="scf-is-attached">'+j.escape(o.name)+" - "+o.size+" bytes</li>");
m.append(q)
}},openAttachmentDialog:function(m){if(h.Util.mayCall(m,"preventDefault")){m.preventDefault()
}this.$el.find("input[type='file']").first().click()
}});
var k=i.Collection.extend({collectionName:"CommentList"});
var g=h.Model.extend({modelName:"AuthorModel"});
var c=h.View.extend({viewName:"Author",tagName:"div",className:"author"});
h.Comment=d;
h.CommentSystem=f;
h.CommentView=a;
h.CommentSystemView=e;
h.CommentList=k;
h.Author=g;
h.AuthorView=c;
h.registerComponent("social/commons/components/hbs/comments/comment",h.Comment,h.CommentView);
h.registerComponent("social/commons/components/hbs/comments",h.CommentSystem,h.CommentSystemView)
})($CQ,_,Backbone,SCF);
(function(g,f,b,d,a,e,c){e.I18n.setLocale(c("meta#siteLanguage").attr("value"))
})(Handlebars,moment,SCF,$CQ,_,CQ,$);